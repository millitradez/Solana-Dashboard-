<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Solana Manual Trade — Coin98 (Mainnet)</title>
<style>
  :root{--bg:#071827;--panel:rgba(255,255,255,0.03);--accent:#00d36a;--muted:#97bcd6;--danger:#ff6b6b}
  body{margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,#022636,#001827);color:#ecf8ff}
  .wrap{max-width:980px;margin:18px auto;padding:16px;display:grid;gap:14px}
  .panel{background:var(--panel);padding:12px;border-radius:10px}
  h1{margin:0 0 6px 0;font-size:20px}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:inherit}
  button{cursor:pointer}
  button.primary{background:var(--accent);color:#012;font-weight:700;border-radius:8px}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#cfe}
  .chart-mini{height:220px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
  iframe{width:100%;height:100%;border:0}
  .log{font-family:monospace;background:#001b33;padding:10px;border-radius:8px;color:#9ff3d0;max-height:220px;overflow:auto}
  .small{font-size:13px}
  footer{font-size:13px;color:#bcd}
  a { color: #cfe; text-decoration: none; }
  @media(max-width:720px){.chart-mini{height:180px}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Solana Manual Trade (Mainnet)</h1>
      <div class="muted">Paste a token mint, fetch a Jupiter quote, sign with Coin98 to execute. Embedded mini DexScreener chart below.</div>
    </header>

    <div class="panel row" style="justify-content:space-between;align-items:center">
      <div class="row">
        <button id="connectBtn" class="primary">Connect Coin98</button>
        <div id="walletShort" class="muted small" style="margin-left:8px">Not connected</div>
      </div>
      <div class="muted small">Network: <strong>mainnet-beta</strong></div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row" style="align-items:center;gap:10px">
          <input id="mintInput" placeholder="Paste token mint (leave blank = SOL)" style="min-width:220px" />
          <select id="quick">
            <option value="">Quick pick</option>
            <option value="So11111111111111111111111111111111111111112">SOL</option>
            <option value="EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v">USDC</option>
            <option value="DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjr9mXAdrsXgPa">BONK</option>
          </select>
          <button id="submitBtn" class="ghost">Load</button>
        </div>
        <div class="row">
          <button id="openDexBtn" class="ghost">Open DexScreener</button>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div id="tokenHeader" style="font-weight:700">Selected: SOL (default)</div>
          <div id="tokenSub" class="muted small">Price: loading…</div>
        </div>
        <div>
          <button id="addWatch" class="ghost">Add to Watchlist</button>
        </div>
      </div>

      <div class="chart-mini" id="chartWrap" style="margin-top:10px">
        <!-- DexScreener default page; script updates src with selected mint -->
        <iframe id="dexFrame" src="https://dexscreener.com/solana" title="Dexscreener mini"></iframe>
      </div>
    </div>

    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Trade (Manual)</strong></div>
        <div class="muted small">You must approve every transaction in Coin98</div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div style="min-width:120px">
          <div class="small muted">Amount (SOL or token)</div>
          <input id="amount" placeholder="e.g. 0.1" />
        </div>

        <div style="min-width:150px">
          <div class="small muted">Side</div>
          <select id="side">
            <option value="sol-to-token">Buy (SOL → token)</option>
            <option value="token-to-sol">Sell (token → SOL)</option>
          </select>
        </div>

        <div style="min-width:110px">
          <div class="small muted">Slippage %</div>
          <input id="slippage" value="1" />
        </div>

        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="quoteBtn" class="ghost">Get Quote</button>
          <button id="executeBtn" class="primary">Execute (Sign & Send)</button>
          <a id="openJupiter" class="ghost" target="_blank" rel="noopener">Open Jupiter</a>
        </div>
      </div>

      <div id="quoteBox" style="margin-top:12px" class="muted small">Quote will appear here after you click Get Quote.</div>
    </div>

    <div class="panel" style="display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:200px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Watchlist</strong></div>
          <div>
            <button id="exportWL" class="ghost">Export</button>
            <button id="clearWL" class="ghost">Clear</button>
          </div>
        </div>
        <div id="watchlist" style="margin-top:8px" class="small muted">Empty</div>
      </div>

      <div style="flex:1;min-width:260px">
        <div><strong>Logs</strong></div>
        <div id="log" class="log" style="margin-top:8px">Logs appear here. Verify transactions carefully.</div>
      </div>
    </div>

    <footer class="panel">
      <div style="font-weight:700;color:var(--danger)">Warning & safety</div>
      <div class="muted small" style="margin-top:6px">
        This UI constructs real mainnet transactions. Test with a very small amount first. Only open this page inside the Coin98 mobile browser to connect & sign.
      </div>
    </footer>
  </div>

<script type="module">
/* -----------------------------------------------------------
  Single-file frontend:
  - Detects Coin98 (window.coin98.sol)
  - Uses Jupiter v6 quote + swap-build endpoints
  - Embeds DexScreener mini chart
  - Produces real mainnet transactions (you must confirm signing)
----------------------------------------------------------- */
import { Connection, Transaction, PublicKey } from "https://esm.sh/@solana/web3.js@1.95.1";

const RPC = "https://api.mainnet-beta.solana.com";
const connection = new Connection(RPC, "confirmed");
const JUPITER_QUOTE = "https://quote-api.jup.ag/v6/quote";
const JUPITER_SWAP  = "https://quote-api.jup.ag/v6/swap";
const DEXS_API = "https://api.dexscreener.com/latest/dex/tokens/";
const SOL_MINT = "So11111111111111111111111111111111111111112";

const dexFrame = document.getElementById('dexFrame');
const mintInput = document.getElementById('mintInput');
const quick = document.getElementById('quick');
const submitBtn = document.getElementById('submitBtn');
const openDexBtn = document.getElementById('openDexBtn');
const tokenHeader = document.getElementById('tokenHeader');
const tokenSub = document.getElementById('tokenSub');
const connectBtn = document.getElementById('connectBtn');
const walletShort = document.getElementById('walletShort');
const addWatch = document.getElementById('addWatch');
const watchlistEl = document.getElementById('watchlist');
const exportWL = document.getElementById('exportWL');
const clearWL = document.getElementById('clearWL');
const logEl = document.getElementById('log');
const amountInput = document.getElementById('amount');
const sideSelect = document.getElementById('side');
const slippageInput = document.getElementById('slippage');
const quoteBtn = document.getElementById('quoteBtn');
const executeBtn = document.getElementById('executeBtn');
const quoteBox = document.getElementById('quoteBox');
const openJupiter = document.getElementById('openJupiter');

let provider = null;
let connectedPubkey = null;
let selectedMint = SOL_MINT;
let lastQuote = null;
let watchlist = JSON.parse(localStorage.getItem('watchlist_v2') || '[]');

function log(msg){
  logEl.innerHTML = `[${new Date().toLocaleTimeString()}] ${msg}<br>` + logEl.innerHTML;
  console.debug(msg);
}
function short(s){ return (s||'').slice(0,6) + '...' + (s||'').slice(-4); }
function looksLikeKey(v){ try { new PublicKey(v); return true } catch(e){ return false } }

function detectProvider(){
  if (window.coin98 && window.coin98.sol) {
    provider = window.coin98.sol;
    log('Detected Coin98 provider');
    connectBtn.textContent = 'Connect Coin98';
  } else {
    provider = null;
    log('Coin98 not detected — open inside Coin98 browser.');
    connectBtn.textContent = 'Open in Coin98';
  }
}

async function connectWallet(){
  if (!provider) { alert('Open this page in the Coin98 in-app browser to connect'); return; }
  try {
    let resp;
    if (provider.connect) resp = await provider.connect();
    else resp = await provider.request({ method: 'connect' });
    let pub = null;
    if (resp?.publicKey) pub = resp.publicKey.toString();
    if (!pub && resp?.toString) pub = resp.toString();
    connectedPubkey = pub;
    walletShort.textContent = `Connected: ${short(pub)}`;
    log('Connected: ' + pub);
  } catch(e){
    walletShort.textContent = 'Connection rejected';
    log('Connect error: ' + (e.message||e));
  }
}

async function loadDexscreenerFor(mint){
  const query = mint || SOL_MINT;
  tokenHeader.textContent = 'Selected: ' + (mint ? short(mint) : 'SOL (default)');
  tokenSub.textContent = 'Loading price…';
  try {
    dexFrame.src = 'https://dexscreener.com/solana/' + encodeURIComponent(query);
    const res = await fetch(DEXS_API + query);
    if (!res.ok) throw new Error('Dexscreener API ' + res.status);
    const json = await res.json();
    const p = (json?.pairs && json.pairs[0]) || null;
    if (p) {
      const priceUsd = p.priceUsd || p.price;
      const change = p.priceChange || p.priceChangePercent || '';
      tokenSub.textContent = priceUsd ? `Price: $${Number(priceUsd).toFixed(6)} • 24h: ${change}%` : 'Price: N/A';
      log('Dexscreener loaded for ' + query);
    } else {
      tokenSub.textContent = 'No pair found on Dexscreener';
      log('Dex: no pairs for ' + query);
    }
  } catch(err){ tokenSub.textContent = 'Dex load error'; log('Dex fetch error: ' + (err.message||err)); }
}

function toLamports(amountSol){
  return Math.round(Number(amountSol) * 1_000_000_000);
}
function toTokenSmall(amount, decimals=6){
  return Math.round(Number(amount) * Math.pow(10, decimals));
}

async function getJupiterQuote(inputMint, outputMint, amount, slippage){
  const url = new URL(JUPITER_QUOTE);
  url.searchParams.set('inputMint', inputMint);
  url.searchParams.set('outputMint', outputMint);
  url.searchParams.set('amount', String(amount));
  url.searchParams.set('slippageBps', String(Math.round(slippage*100)));
  log('Requesting Jupiter quote...');
  const res = await fetch(url.toString());
  if (!res.ok) {
    const body = await res.text();
    throw new Error('Quote HTTP ' + res.status + ' - ' + body.slice(0,500));
  }
  const j = await res.json();
  if (!j || !j.data || j.data.length === 0) throw new Error('No routes returned by Jupiter');
  return j;
}

async function buildJupiterSwap(route, userPublicKey){
  const body = { route, userPublicKey };
  const res = await fetch(JUPITER_SWAP, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error('Swap build failed: ' + res.status + ' - ' + txt.slice(0,1000));
  }
  return await res.json();
}

/* UI handlers */
submitBtn.addEventListener('click', async ()=>{
  const v = (mintInput.value||'').trim();
  if (!v) { selectedMint = SOL_MINT; await loadDexscreenerFor(SOL_MINT); return; }
  if (!looksLikeKey(v)) return alert('Invalid mint');
  selectedMint = v;
  await loadDexscreenerFor(v);
  if (!watchlist.includes(v)) { watchlist.unshift(v); localStorage.setItem('watchlist_v2', JSON.stringify(watchlist)); renderWatchlist(); }
});
quick.addEventListener('change', ()=>{ if(quick.value){ mintInput.value=quick.value; submitBtn.click(); }});
openDexBtn.addEventListener('click', ()=> window.open('https://dexscreener.com/solana','_blank'));
addWatch.addEventListener('click', ()=>{ const m=(mintInput.value||'').trim(); if(!m||!looksLikeKey(m)) return alert('Select valid mint'); if(!watchlist.includes(m)){ watchlist.unshift(m); localStorage.setItem('watchlist_v2',JSON.stringify(watchlist)); renderWatchlist(); log('Added '+m);} });

exportWL.addEventListener('click', ()=>{ const blob = new Blob([watchlist.join('\n')], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='watchlist.txt'; a.click();});
clearWL.addEventListener('click', ()=>{ if(!confirm('Clear watchlist?')) return; watchlist=[]; localStorage.setItem('watchlist_v2',JSON.stringify(watchlist)); renderWatchlist(); log('Watchlist cleared');});

quoteBtn.addEventListener('click', async ()=>{
  try {
    quoteBox.textContent = 'Requesting Jupiter quote...';
    const mint = selectedMint || SOL_MINT;
    if (!mint) return alert('Select token first');
    const side = sideSelect.value;
    const amountUi = Number(amountInput.value);
    if (!amountUi || amountUi <= 0) return alert('Enter amount');
    const slippage = Number(slippageInput.value) || 1;
    const isBuy = side === 'sol-to-token';
    const inputMint = isBuy ? SOL_MINT : mint;
    const outputMint = isBuy ? mint : SOL_MINT;
    const amountSmall = isBuy ? toLamports(amountUi) : toTokenSmall(amountUi, 6);
    const q = await getJupiterQuote(inputMint, outputMint, amountSmall, slippage);
    const best = q.data[0];
    lastQuote = best;
    const outDecimals = outputMint === SOL_MINT ? 9 : (best?.outAmountDecimals || 6);
    const outUi = (best.outAmount || 0) / Math.pow(10, outDecimals);
    quoteBox.innerHTML = `Estimated out: ${outUi.toFixed(6)} • route markets: ${best.marketInfos?.length||0}`;
    openJupiter.href = `https://jup.ag/swap?inputMint=${inputMint}&outputMint=${outputMint}&amount=${amountSmall}&slippage=${Math.round(slippage*100)}`;
    log('Quote ready');
  } catch(e){ quoteBox.textContent = 'Quote error: ' + (e.message||e); log('Quote error: ' + (e.message||e)); lastQuote = null; }
});

executeBtn.addEventListener('click', async ()=>{
  if (!lastQuote) return alert('Get a quote first');
  if (!provider) return alert('Open this page in the Coin98 in-app browser to sign');
  if (!connectedPubkey) { await connectWallet(); if(!connectedPubkey) return alert('Connect wallet first'); }
  if (!confirm('This will build a MAINNET swap transaction and request a signature in your wallet. Continue?')) return;
  try {
    const route = lastQuote;
    const build = await buildJupiterSwap(route, connectedPubkey);
    if (!build || !build.swapTransaction) throw new Error('No swap transaction returned from Jupiter');
    const b64 = build.swapTransaction;
    const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    const tx = Transaction.from(raw);
    log('Requesting wallet signature — inspect popup carefully.');
    let signed;
    if (provider.signTransaction) {
      signed = await provider.signTransaction(tx);
    } else if (provider.request) {
      signed = await provider.request({ method: 'signTransaction', params: { transaction: b64 }});
    } else {
      throw new Error('Coin98 provider missing signTransaction.');
    }
    const serialized = signed.serialize ? signed.serialize() : (signed.raw || signed);
    const txid = await connection.sendRawTransaction(serialized, { skipPreflight: false });
    log('Submitted tx: ' + txid);
    quoteBox.innerHTML += `<div><a target="_blank" rel="noopener" href="https://explorer.solana.com/tx/${txid}?cluster=mainnet-beta">View on Explorer</a></div>`;
    await connection.confirmTransaction(txid, 'confirmed');
    log('Transaction confirmed: ' + txid);
    alert('Swap confirmed: ' + txid);
  } catch(e) { log('Execution error: ' + (e.message||e)); alert('Swap failed: ' + (e.message||e)); }
});

/* connect & init */
connectBtn.addEventListener('click', connectWallet);

function renderWatchlist(){ if(!watchlist||watchlist.length===0){ watchlistEl.innerHTML='<div class="muted small">Empty</div>'; return } watchlistEl.innerHTML = watchlist.map(m=>`<div style="display:flex;justify-content:space-between;align-items:center"><div style="word-break:break-all">${m}</div><div><button class="ghost" onclick="(function(){ window.selectWatch('${m}') })()">View</button></div></div>`).join(''); window.selectWatch = (m)=>{ mintInput.value=m; submitBtn.click(); } }

async function init(){
  detectProvider();
  renderWatchlist();
  await loadDexscreenerFor(SOL_MINT);
  log('Ready. Open inside Coin98 to trade (mainnet).');
}
window.addEventListener('load', init);
</script>
</body>
</html>
