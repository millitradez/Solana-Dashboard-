<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Solana Dashboard ‚Äî Coin98</title>
  <style>
    :root{--accent:#00d4aa;--bg1:#6b46c1;--bg2:#9f7aea}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;min-height:100vh}
    .wrap{max-width:760px;margin:24px auto;padding:18px}
    header{text-align:center;margin-bottom:18px}
    h1{margin:6px 0;font-size:28px}
    p.lead{margin:0;color:rgba(255,255,255,.9)}
    .card{background:#fff;color:#222;border-radius:14px;padding:18px;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .btn{background:linear-gradient(90deg,var(--accent),#00b894);border:none;color:#fff;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;width:100%}
    .muted{color:#666;font-size:14px}
    input[type="text"]{width:100%;padding:12px;border-radius:10px;border:1px solid #e6e6e6;font-size:15px}
    .small{font-size:13px;color:#666}
    .result-row{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .chip{background:#f5f5f5;padding:8px 12px;border-radius:999px;color:#333}
    .ok{background:#d4edda;color:#155724;padding:10px;border-radius:8px}
    .err{background:#f8d7da;color:#721c24;padding:10px;border-radius:8px}
    code{background:#f3f4f6;padding:4px 6px;border-radius:6px;font-size:13px}
    pre.debug{background:#0b1220;color:#d6f8f1;padding:10px;border-radius:8px;overflow:auto;max-height:240px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üöÄ Solana Dashboard</h1>
      <p class="lead">Coin98-only ¬∑ token mint/account lookup ¬∑ balances</p>
    </header>

    <div id="banner" class="card" style="text-align:center;">
      <div id="banner-msg" class="muted">Open inside the Coin98 browser and connect your wallet.</div>
    </div>

    <div class="card">
      <h3>üíº Wallet</h3>
      <button id="connectBtn" class="btn">üíé Connect Coin98 Wallet</button>
      <div style="margin-top:12px">
        <div id="walletStatus" class="small muted">Not connected</div>
        <div id="walletAddr" style="margin-top:8px;font-family:monospace"></div>
      </div>
    </div>

    <div class="card">
      <h3>üîç Token lookup (mint or token account)</h3>
      <input id="tokenInput" type="text" placeholder="Paste mint address or token account address" />
      <div style="height:12px"></div>
      <button id="lookupBtn" class="btn">Load token info</button>

      <div id="tokenResult" style="margin-top:14px"></div>
    </div>

    <div class="card">
      <h3>üêû Debug output</h3>
      <div class="small muted">Provider & network debug logs (use when troubleshooting)</div>
      <pre id="debugOut" class="debug"></pre>
    </div>

    <footer style="text-align:center;color:rgba(255,255,255,.9);margin-top:8px">
      Built by millitradez ‚Äî Coin98
    </footer>
  </div>

  <script>
  // ---------- Helper UI ----------
  const bannerMsg = document.getElementById('banner-msg');
  const connectBtn = document.getElementById('connectBtn');
  const walletStatus = document.getElementById('walletStatus');
  const walletAddrEl = document.getElementById('walletAddr');
  const lookupBtn = document.getElementById('lookupBtn');
  const tokenInput = document.getElementById('tokenInput');
  const tokenResult = document.getElementById('tokenResult');
  const debugOut = document.getElementById('debugOut');

  function showBanner(text, type='info'){
    bannerMsg.textContent = text;
    bannerMsg.style.color = (type==='err') ? '#ffdddd' : (type==='ok' ? '#d4ffea' : 'rgba(255,255,255,.9)');
  }
  function showResult(html, ok=false){
    tokenResult.innerHTML = html;
    tokenResult.className = ok ? 'ok' : 'err';
  }
  function appendDebug(...args){
    try {
      const lines = args.map(a => {
        if(typeof a === 'string') return a;
        try { return JSON.stringify(a, null, 2); } catch(e){ return String(a); }
      });
      debugOut.textContent = debugOut.textContent + lines.join(' ') + '\n\n';
      debugOut.scrollTop = debugOut.scrollHeight;
      console.debug(...args);
    } catch(e){ console.debug('debug append error', e); }
  }

  // ---------- Solana RPC helper ----------
  // If your RPC provider requires an API key or is rejecting with "invalid token",
  // try switching to a public RPC (for testing) such as https://rpc.ankr.com/solana
  const RPC = "https://api.mainnet-beta.solana.com";
  // const RPC = "https://rpc.ankr.com/solana"; // alternative for testing

  async function rpc(method, params){
    const payload = { jsonrpc: "2.0", id: 1, method, params };
    const res = await fetch(RPC, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });

    // read text to make sure we can display raw response when provider replies with
    // a non-json or application level error (like "invalid token")
    const text = await res.text();
    let body = null;
    try { body = JSON.parse(text); } catch(e){ body = null; }

    if(!res.ok) {
      const msg = `Network error ${res.status} ${res.statusText} ‚Äî response: ${text}`;
      appendDebug({rpc_error_network: msg});
      throw new Error(msg);
    }
    if(body && body.error) {
      const msg = `RPC error: ${body.error.code || ''} ${body.error.message || JSON.stringify(body.error)}`;
      appendDebug({rpc_error_body: body});
      throw new Error(msg);
    }
    if(!body) {
      // not JSON ‚Äî surface raw text
      appendDebug({rpc_unexpected_text: text});
      throw new Error('RPC returned non-JSON response: ' + text);
    }
    return body.result;
  }

  // ---------- Wallet (Coin98-only) ----------
  let coin98Wallet = null;
  let connectedPubkey = null;

  // waits up to ~5s for injection
  async function waitForCoin98(timeoutMs=5000){
    const start = Date.now();
    while(Date.now() - start < timeoutMs){
      if(window.coin98 && (window.coin98.sol || window.coin98.provider)) return window.coin98;
      await new Promise(r => setTimeout(r, 300));
    }
    return null;
  }

  function extractPubFromResp(resp, walletObj){
    // try many shapes we might see from different provider versions
    try {
      // resp.publicKey could be a PublicKey object or base58 string
      if(resp) {
        if(typeof resp === 'string') return resp;
        if(resp.publicKey) {
          if(typeof resp.publicKey === 'string') return resp.publicKey;
          if(typeof resp.publicKey.toString === 'function') return resp.publicKey.toString();
          if(typeof resp.publicKey.toBase58 === 'function') return resp.publicKey.toBase58();
        }
        // some providers put address in result.publicKey or in resp.result
        if(resp.result && resp.result.publicKey) {
          if(typeof resp.result.publicKey === 'string') return resp.result.publicKey;
          if(typeof resp.result.publicKey.toString === 'function') return resp.result.publicKey.toString();
        }
      }
      if(walletObj) {
        if(walletObj.publicKey) {
          if(typeof walletObj.publicKey === 'string') return walletObj.publicKey;
          if(typeof walletObj.publicKey.toString === 'function') return walletObj.publicKey.toString();
          if(typeof walletObj.publicKey.toBase58 === 'function') return walletObj.publicKey.toBase58();
        }
      }
    } catch(e){
      appendDebug('extractPubFromResp error', e);
    }
    return null;
  }

  async function connectCoin98(){
    try {
      const c98 = await waitForCoin98(6000);
      if(!c98){
        showBanner('Coin98 not detected ‚Äî open inside Coin98 browser', 'err');
        walletStatus.textContent = 'Not connected';
        appendDebug('Coin98 not found on window');
        return;
      }

      appendDebug('coin98 global object:', c98);

      // try connect API forms
      coin98Wallet = c98.sol || c98.provider || c98;
      appendDebug('coin98Wallet chosen:', coin98Wallet);

      // prefer connect method if available
      let resp = null;
      if(typeof coin98Wallet.connect === 'function'){
        try {
          resp = await coin98Wallet.connect();
        } catch(e){
          appendDebug('connect() threw', e);
          // fall back to request below
          resp = null;
        }
      }
      if(!resp && typeof coin98Wallet.request === 'function'){
        try {
          resp = await coin98Wallet.request({ method: 'connect' });
        } catch(e){ 
          appendDebug('request({method:connect}) threw', e);
          resp = null;
        }
      }

      appendDebug('connect response:', resp);

      const pub = extractPubFromResp(resp, coin98Wallet);
      if(!pub) {
        walletStatus.textContent = 'Connected (pubkey unknown)';
        showBanner('Connected (address not reported). Check debug logs.', 'ok');
        appendDebug('No pubkey could be extracted from response or provider object.');
      } else {
        connectedPubkey = pub;
        walletStatus.textContent = 'Connected';
        walletAddrEl.textContent = pub;
        showBanner('‚úÖ Wallet connected: ' + pub, 'ok');
        appendDebug('Connected pubkey:', pub);
      }
    } catch(err) {
      console.error('connect error', err);
      appendDebug('connect error', err && (err.message || err));
      showBanner('Connection failed ‚Äî check debug output', 'err');
      walletStatus.textContent = 'Not connected';
    }
  }

  connectBtn.addEventListener('click', connectCoin98);

  // ---------- Token lookup logic ----------
  async function loadTokenInfo(){
    tokenResult.innerHTML = '';
    tokenResult.className = '';
    const raw = tokenInput.value.trim();
    if(!raw) { showResult('Enter a mint or token account address'); return; }

    showResult('‚è≥ Checking address...', false);
    try {
      // 1) Try getTokenSupply (mint case)
      let supplyRes = null;
      try {
        supplyRes = await rpc('getTokenSupply', [raw]);
      } catch(e){
        // surface RPC error so user sees "invalid token" message if returned by RPC host
        appendDebug('getTokenSupply error', e && e.message ? e.message : e);
        supplyRes = null;
      }

      let mint = null;
      let tokenAccountInfo = null;

      if(supplyRes && supplyRes.value){
        // input is a mint
        mint = raw;
      } else {
        // 2) treat as token account / any account
        try {
          const parsed = await rpc('getParsedAccountInfo', [raw, {encoding: 'jsonParsed'}]);
          appendDebug('getParsedAccountInfo result', parsed);
          if(parsed && parsed.value && parsed.value.data && parsed.value.data.parsed){
            const info = parsed.value.data.parsed.info;
            if(info && info.mint){
              mint = info.mint;
              tokenAccountInfo = info;
            }
          }
        } catch(err){
          appendDebug('getParsedAccountInfo error', err && err.message ? err.message : err);
        }
      }

      if(!mint){
        showResult('‚ùå Could not determine mint for the address. If you see "invalid token" in debug logs, the RPC host may be rejecting your request (API key required or rate-limited). See debug panel below.', false);
        return;
      }

      // Now fetch supply if not already fetched
      let supply = supplyRes;
      if(!supply){
        try { supply = await rpc('getTokenSupply', [mint]); }
        catch(e){ 
          appendDebug('getTokenSupply (second attempt) error', e && e.message ? e.message : e);
          supply = null; 
        }
      }

      if(!supply || !supply.value){
        showResult('‚ùå Could not fetch supply for mint: ' + mint + '. See debug panel for RPC response.', false);
        return;
      }

      const decimals = supply.value.decimals;
      const uiSupply = supply.value.uiAmountString || (supply.value.amount / Math.pow(10, decimals));

      let ownerBalanceStr = null;
      if(connectedPubkey){
        try {
          const ownerRes = await rpc('getTokenAccountsByOwner', [connectedPubkey, {mint: mint}, {encoding: 'jsonParsed'}]);
          appendDebug('getTokenAccountsByOwner', ownerRes);
          if(ownerRes && Array.isArray(ownerRes.value) && ownerRes.value.length > 0){
            let sum = 0;
            for(const a of ownerRes.value){
              const info = a.account?.data?.parsed?.info;
              if(info && info.tokenAmount && typeof info.tokenAmount.uiAmount === 'number'){
                sum += info.tokenAmount.uiAmount;
              }
            }
            ownerBalanceStr = String(sum);
          } else {
            ownerBalanceStr = "0";
          }
        } catch(err){
          appendDebug('owner balance fetch failed', err && err.message ? err.message : err);
        }
      }

      let tokenAccountBalanceText = '';
      if(tokenAccountInfo && tokenAccountInfo.tokenAmount){
        const ta = tokenAccountInfo.tokenAmount;
        tokenAccountBalanceText = `Token account balance: ${ta.uiAmount} (raw: ${ta.amount}, decimals: ${ta.decimals})`;
      }

      const out = `
        ‚úÖ <strong>Mint:</strong> <code>${mint}</code><br>
        <strong>Decimals:</strong> ${decimals}<br>
        <strong>Total supply:</strong> ${uiSupply}<br>
        ${ tokenAccountBalanceText ? `<div style="margin-top:8px">${tokenAccountBalanceText}</div>` : '' }
        ${ ownerBalanceStr !== null ? `<div style="margin-top:8px"><strong>Your balance:</strong> ${ownerBalanceStr}</div>` : '' }
      `;
      showResult(out, true);

    } catch(err){
      console.error('loadTokenInfo error', err);
      appendDebug('loadTokenInfo error', err && (err.message || err));
      showResult('‚ùå Error loading token info. Check debug output below.', false);
    }
  }

  lookupBtn.addEventListener('click', loadTokenInfo);

  (async function init(){
    const c98 = await waitForCoin98(3000);
    if(c98){
      showBanner('Coin98 wallet is available ‚Äî press Connect', 'ok');
      appendDebug('Coin98 detected on window:', c98);
    } else {
      showBanner('Open this page inside the Coin98 in-app browser to connect your wallet.', 'info');
    }
  })();
  </script>
</body>
</html>
